"use strict";(self["webpackChunkkams"]=self["webpackChunkkams"]||[]).push([[5],{1349:function(e,t,s){s.d(t,{A:function(){return d}});var n=function(){var e=this,t=e._self._c;return t("aside",{ref:"aside",staticClass:"k-sb-aside k-aside"},[t("div",{staticClass:"k-aside-default"},[e._t("default")],2),t("div",{staticClass:"k-aside-inner"},[e._t("inner")],2)])},r=[],i={name:"k-sb-aside"},a=i,o=s(1656),l=(0,o.A)(a,n,r,!1,null,null,null),d=l.exports},5675:function(e,t,s){s.d(t,{A:function(){return d}});var n=function(){var e=this,t=e._self._c;return t("section",{staticClass:"k-container",class:`k-container-${e.direction}`},[e._t("default")],2)},r=[],i={name:"k-container",props:{direction:{type:String,default:"horizontal"}},computed:{}},a=i,o=s(1656),l=(0,o.A)(a,n,r,!1,null,null,null),d=l.exports},4844:function(e,t,s){s.d(t,{A:function(){return c}});var n=function(){var e=this,t=e._self._c;return t("ul",{staticClass:"k-menu",style:{flexDirection:this.mode}},[e._t("default")],2)},r=[],i=(s(4114),s(6848)),a={name:"k-menu",data(){return{activeIndex:this.defaultActive}},provide(){return{root:this}},props:{activeColor:{type:String},activeShape:{type:Array,default(){return[]}},backgroundColor:{type:String},textColor:{},mode:{type:String,default(){return"column"}},defaultActive:{type:String},router:{type:Boolean}},methods:{changeRouteFn(e){this.router&&this.$router.push(e),this.activeIndex=e}},computed:{rootMenu(){return{activeColor:this.activeColor,backgroundColor:this.backgroundColor,activeIndex:this.defaultActive}}},watch:{defaultActive(e){this.activeIndex=e}},beforeCreate(){this.$bus=new i["default"]},mounted(){this.$bus.$on("changeRoute",this.changeRouteFn)},beforeDestroy(){this.$bus.$off("changeRoute",this.changeRouteFn)}},o=a,l=s(1656),d=(0,l.A)(o,n,r,!1,null,"8321ac56",null),c=d.exports},2222:function(e,t,s){s.d(t,{A:function(){return d}});var n=function(){var e=this,t=e._self._c;return t("el-tooltip",{ref:"tooltip",staticClass:"item",attrs:{disabled:!e.tips,effect:"dark",content:e.title,placement:"right",manual:""}},[t("li",{staticClass:"k-menu-item",class:[{className:e.className},{active:e.active},e.direction],style:[e.itemStyle,{height:`${e.height}px`,minHeight:`${e.height}px`},{justifyContent:e.align}],on:{mouseenter:e.onmouseenterFn,mouseleave:e.onMouseLeaveFn,click:e.handleClickFn}},[e.activeShape.includes("line")?[t("transition",{attrs:{appear:"",name:"appear"}},[t("div",{directives:[{name:"show",rawName:"v-show",value:e.active,expression:"active"}],staticClass:"current-shape line",style:{background:e.root.activeColor}})])]:e._e(),e.activeShape.includes("circle")?[t("transition",{attrs:{appear:""}},[t("div",{directives:[{name:"show",rawName:"v-show",value:e.active,expression:"active"}],staticClass:"current-shape circle",style:e.circleStyle})])]:e._e(),e._t("default")],2)])},r=[],i={name:"k-menu-item",data(){return{activeColor:this.root.activeColor}},inject:["root"],methods:{onmouseenterFn(){this.$el.style.backgroundColor=this.root.backgroundColor,this.handleTooltipFn(!0)},onMouseLeaveFn(){this.activeShape.includes("background")&&this.active||(this.$el.style.backgroundColor="",this.handleTooltipFn(!1))},handleClickFn(){this.root.$bus.$emit("changeRoute",this.index),this.$emit("click",this),this.root.$emit("select",this)},handleTooltipFn(e){this.$refs.tooltip.showPopper=e}},computed:{active(){if(!this.root.router)return this.root.activeIndex===this.index;const e=this.root.activeIndex.split("/"),t=this.index.split("/");return e.includes(t[1])},itemStyle(){const e={color:this.active?this.root.activeColor:this.root.textColor,borderLeftColor:this.active?this.root.activeColor:this.root.textColor,backgroundColor:""};return this.activeShape.includes("background")&&(e.backgroundColor=this.active?this.root.backgroundColor:""),e},circleStyle(){return{border:`3px solid ${this.root.activeColor}`,filter:`drop-shadow(0 0 4px ${this.root.activeColor})`}},activeShape(){return this.root.activeShape},tips(){return!!this.title},direction(){return`k-menu-item-${this.root.mode}`}},beforeMount(){},mounted(){},props:{icon:{type:String,default(){return""}},index:{type:String},title:{type:String},width:{type:String,default(){return"70"}},height:{type:String,default(){return"70"}},className:{type:String,default(){return""}},align:{type:String,default(){return"center"}}}},a=i,o=s(1656),l=(0,o.A)(a,n,r,!1,null,"dbebb810",null),d=l.exports},6221:function(e,t,s){s.r(t),s.d(t,{default:function(){return Me}});var n=function(){var e=this,t=e._self._c;return t("k-container",{directives:[{name:"loading",rawName:"v-loading",value:0,expression:"0"}],staticClass:"k-sb-container",attrs:{direction:"horizontal"}},[t("sb-left-aside",{ref:"leftAsideRef",attrs:{updateChatTarget:e.updateChatTargetFn,updateCollapseMsg:e.updateCollapseMsgFn},on:{switchMsg:e.switchMsgCallback,handleMenuAction:e.handleMenuAction}}),t("k-container",{directives:[{name:"show",rawName:"v-show",value:e.show.isShowChatBox,expression:"show.isShowChatBox"}],staticClass:"k-sb-main",attrs:{direction:"vertical"}},[t("header",{directives:[{name:"show",rawName:"v-show",value:e.show.isShowChatBox,expression:"show.isShowChatBox"}],staticClass:"k-chat-header"},[t("gray-button",{directives:[{name:"show",rawName:"v-show",value:!e.show.isCollapseMsg,expression:"!show.isCollapseMsg"}],staticClass:"icon-btn",nativeOn:{click:function(t){return e.collapseMsghandler()}}},[t("el-tooltip",{attrs:{effect:"dark",content:"展开消息列表",placement:"right"}},[t("pps-icon",{attrs:{icon:"pps-icon-side-hide"}})],1)],1),t("div",{staticClass:"k-chat-header-content"},[t("h1",{staticClass:"k-chat-header-title"},[e._v(e._s(e.chatTarget.name)+e._s(e.getGroupMemberLength))])]),t("gray-button",{directives:[{name:"show",rawName:"v-show",value:e.chatTarget.isGroup,expression:"chatTarget.isGroup"}],staticClass:"showGroupInfo",nativeOn:{click:function(t){return e.collapseRighthandler()}}},[t("i",{staticClass:"el-icon-more"})])],1),t("k-container",{staticClass:"k-chat-main",attrs:{direction:"horizontal"}},[t("sb-chat-main",{ref:"chatMainRef",attrs:{chatTarget:e.chatTarget,memberList:e.getMemberList},on:{handleMenuAction:e.handleMenuAction}}),e.chatTarget.isGroup?t("sb-right-aside",{directives:[{name:"show",rawName:"v-show",value:e.show.isCollapseRight,expression:"show.isCollapseRight"}],attrs:{chatTarget:e.chatTarget,memberList:e.getMemberList},on:{handleMenuAction:e.handleMenuAction}}):e._e(),e.chatTarget.isGroup?t("div",{directives:[{name:"show",rawName:"v-show",value:e.isShowRightMask,expression:"isShowRightMask"}],staticClass:"mask",on:{click:function(t){return e.collapseRighthandler()}}}):e._e()],1)],1)],1)},r=[],i=s(3518),a=s(3722);class o{constructor({name:e,numId:t,id:s,lord:n,avatar:r}){this.id=s||`group-${t}`,this.numId=t||this.self().numId,this.name=e||this.self().name,this.lord=n||this.self().lord,this.avatar=r||`https://k.hotaru.icu/api/data/avatar/${e}`,this.admins=this.self().admins||[],this.members=this.self().members||[]}mount(){return a.A.commit("sandBox/ADD_GROUP",this),a.A.commit("sandBox/CREATE_GROUP_MESSAGE",this),this}getAllMember(){return this.self().members.map((({id:e,role:t})=>{const s=a.A.getters["sandBox/getUserById"](e);return{...s,role:t}}))}getMemberById(e){return this.getAllMember().find((t=>t.id===e))||null}getAllMessage(){return a.A.getters["sandBox/getGroupMessage"](this.id)}addMember({uid:e,role:t}){a.A.commit("sandBox/ADD_MEMBER",{gid:this.id,uid:e,role:t})}removeMember(e){a.A.commit("sandBox/REMOVE_MEMBER",{gid:this.id,uid:e})}self(){return a.A.getters["sandBox/getGroupById"](this.id)}}s(6573),s(8100),s(7936),s(7467),s(4732),s(9577);const l="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let d=(e=21)=>{let t="",s=crypto.getRandomValues(new Uint8Array(e));while(e--)t+=l[63&s[e]];return t};const c="self",u="friend";class h{constructor({numId:e,name:t,age:s,sex:n,avatar:r,id:i}){this.name=t||this.self().name,this.id=i||`user-${e}`,this.numId=e||this.self().numId,this.age=s||this.self().age,this.sex=n||this.self().sex,this.order=this.self().order||a.A.state.sandBox.registeredUsersCount;const o=this.order*10**(this.order%2)*10;this.avatar=r||`https://picsum.photos/id/${o}/50/50`,this.groups=this.self().groups||[],this.friends=this.self().friends||[]}mount(){const e=a.A.getters["sandBox/getUserById"](this.id);return!e&&(a.A.commit("sandBox/ADD_USER",this),a.A.commit("sandBox/CREATE_PRIVATE_MESSAGE",this.id),this.addFriend("user-super-admin"),this)}getAllFriend(){return this.self().friends}getAllGroups(){const e=this.self().groups.map((({id:e})=>e)),t=e.map((e=>a.A.getters["sandBox/getGroupById"](e)));return t}getGroupById(e){const t=this.self().groups.some((({id:t})=>t===e));return t&&a.A.getters["sandBox/getGroupById"](e)}addFriend(e){const t=a.A.getters["sandBox/getUserById"](e),s=this.self().friends?.some((t=>t.id===e));return!(!t||s||e===this.id)&&(a.A.commit("sandBox/ADD_FRIEND",{fid:e,id:this.id}),a.A.commit("sandBox/INIT_PRIVATE_MESSAGE",{id:this.id,fid:e}),this.sendMessageToFriend({id:e,content:"我们已成功添加为好友，现在可以开始聊天啦～"}),this.receiveAddFriend(t),!0)}receiveAddFriend(e){a.A.commit("sandBox/ADD_FRIEND",{fid:this.id,id:e.id});const t=a.A.getters["sandBox/getPrivateMessage"](e.id);Reflect.has(t,this.id)||(a.A.commit("sandBox/INIT_PRIVATE_MESSAGE",{id:e.id,fid:this.id}),console.log(`${this.self().name}已添加到${e.name}的好友列表中`))}removeFriendById(e){const t=this.deleteFriendMessage(e);t||console.log("删除信息失败");const s=a.A.commit("sandBox/REMOVE_FRIEND",{fid:e,id:this.self().id});return a.A.commit("sandBox/REMOVE_FRIEND",{fid:this.self().id,id:e}),console.log(s),!0}createGroup({id:e,name:t,members:s,avatar:n}){if(!e&&!t)return!1;const r=`group-${e}`,i=this._memberNormalize(s),a=this.getGroupById(r);if(a)return!1;const l=new o({name:t,numId:e,lord:this.id,avatar:n}).mount();return i.forEach((async e=>{const t=e.id,s=this.getUserById(t);if(!s)return console.log(`用户${t}不存在`);const n=t===this.id?"lord":"member";l.addMember({uid:e.id,role:n})})),l.addMember({uid:this.id,role:"lord"}),l.addMember({uid:"user-super-admin",role:"super-admin"}),l}removeGroupById(e){const t=a.A.getters["sandBox/getGroupById"](e);if(!t)return!1;const s=t.lord===this.id||this.self().isSuper;return!!s&&(a.A.commit("sandBox/CLEAR_GROUP_MESSAGE",e),a.A.commit("sandBox/REMOVE_GROUP",e),!0)}addGroupById(e){const t=new o({id:e}),s=t.self();if(!s)return m("User: 群组不存在");const n=t.getAllMember().some((e=>e.id===this.id));return n?m("User: 群组已加入"):(t.addMember({uid:this.id,role:"member"}),!0)}inviteUserToGroup({groupId:e,invitee:t}){const s=new o({id:e}),n=s.self(),r=this._memberNormalize(t),i=s.getMemberById(this.id);return n&&i?(r.forEach((e=>{const t=s.getMemberById(e.id);if(t)return m("User: 该用户已加入群组");s.addMember({uid:e.id,role:"member"})})),!0):m("User: 群组不存在或您不是群主")}leaveGroupById(e){const t=a.A.getters["sandBox/getGroupById"](e);return!!t&&(a.A.commit("sandBox/REMOVE_MEMBER",{gid:e,mid:this.self().id}),!0)}kickMemberById({groupId:e,expellee:t}){const s=a.A.getters["sandBox/getGroupById"](e),n=s.members.some((e=>e.id===t));return s&&n&&t!==this.id?this._isAdmin(e)?!s.admins.some((e=>e===t))&&s.lord!==t&&(a.A.commit("sandBox/REMOVE_MEMBER",{gid:e,mid:t}),!0):m("User: 不是管理员"):m("User: 信息错误")}sendMessageToFriend({id:e,content:t,replyMsg:s=null}){if(!this.self().friends.some((t=>t.id===e)))return!1;const n=d(),r=Date.now(),i={id:n,role:c,receiver:e,content:t,date:r,replyMsg:s},o={sender:this.id,receiver:e,message:i};return a.A.commit("sandBox/SEND_PRIVATE_MESSAGE",o),this.receiveFriendMessage({id:e,content:t,msgId:n,timestamp:r}),{status:!0,data:o}}receiveFriendMessage({id:e,content:t,msgId:s,timestamp:n}){const r={id:s,role:u,content:t,date:n,sender:this.id},i={sender:e,receiver:this.id,message:r};a.A.commit("sandBox/SEND_PRIVATE_MESSAGE",i)}deleteFriendMessage(e,t=null){return!!this.self().friends.some((t=>t.id===e))&&(a.A.commit("sandBox/DEL_PRIVATE_MESSAGE",{sender:e,receiver:this.id,msgId:t}),a.A.commit("sandBox/DEL_PRIVATE_MESSAGE",{sender:this.id,receiver:e,msgId:t}),!0)}sendMessageToGroup({id:e,content:t,replyMsg:s=null}){const n=a.A.getters["sandBox/getGroupById"](e);if(!n)return!1;const r=n.members.some((e=>e.id===this.id));if(!r)return!1;const i=a.A.getters["sandBox/getGroupMessage"](e),o=i.isMute||i.muteMembers.includes(this.id);if(!this._isAdmin(e)&&o)return!1;const l={id:d(),role:this.id,isGroup:!0,content:t,date:Date.now(),replyMsg:s};return a.A.commit("sandBox/SEND_GROUP_MESSAGE",{gid:e,message:l}),{status:!0,data:{gid:e,message:l}}}deleteGroupMessage({id:e,msgId:t}){const s=a.A.getters["sandBox/getGroupById"](e);if(!s)return m("User: 群组不存在");const n=s.members.some((e=>e.id===this.id));if(!n)return m("User: 非群组成员");const r=a.A.getters["sandBox/getGroupMessage"](e),i=r.messages.some((e=>e.id===t));if(!i)return m("User: 消息不存在");const o=r.messages.find((e=>e.id===t)).role===this.id;return this._isAdmin(e)||o?(a.A.commit("sandBox/DEL_GROUP_MESSAGE",{id:e,msgId:t}),!0):m("User: 非管理员或消息作者")}handleMuteGroupById(e,t){return this._isAdmin(e)?(a.A.commit("sandBox/HANDLE_MUTE_GROUP",{gid:e,isMute:t}),!0):m("User: 群组权限不足")}muteMemberById(e,t,s){return!!this._isAdmin(e)&&(!this._isAdmin(e,t)&&(a.A.commit("sandBox/MUTE_MEMBER",{gid:e,mid:t,duration:s}),!0))}unmuteMemberById(e,t){return!!this._isAdmin(e)&&(a.A.commit("sandBox/UNMUTE_MEMBER",{gid:e,mid:t}),!0)}setGroupAdmin({gid:e,mid:t}){if(!this.isLord(e))return!1;const s=this.getGroupById(e);return s.lord!==t&&(!!s.members.some((({id:e})=>e===t))&&(!s.admins.some((e=>e===t))&&(a.A.commit("sandBox/SET_GROUP_ADMIN",{gid:e,mid:t}),!0)))}revokeGroupAdmin(e,t){if(!this.isLord(e))return!1;const s=this.getGroupById(e);if(!s.members.some((({id:e})=>e===t)))return!1;if(!s.admins.some((e=>e===t)))return!1;const n=a.A.commit("sandBox/REVOKE_GROUP_ADMIN",{gid:e,mid:t});return console.log(n),!0}getFriendMessageById(e){const t=a.A.getters["sandBox/getPrivateMessage"](this.id),s=t[e]||[];return s}getGroupMessageById(e){return a.A.getters["sandBox/getGroupMessage"](e)}_memberNormalize(e){let t;return e instanceof Array?e.map((e=>e instanceof Object?e:(t=a.A.getters["sandBox/getUserById"](e),t))).filter((e=>e)):e instanceof Object?[e]:(t=a.A.getters["sandBox/getUserById"](e),t&&"object"===typeof t?[t]:[])}self(){return a.A.getters["sandBox/getUserById"](this.id)}_isAdmin(e,t){const s=a.A.getters["sandBox/getGroupById"](e);if(!s)return!1;const n=t||this.id,r=s.lord===n||this.self().isSuper,i=s.admins.some((e=>e===n))||r;return i}isLord(e,t){const s=a.A.getters["sandBox/getGroupById"](e),n=t||this.id,r=s.lord===n||this.self().isSuper;return r}}const m=e=>(console.error(e),!1);class g{getAllUser(){return a.A.getters["sandBox/getAllUser"]}getUserById(e){return a.A.getters["sandBox/getUserById"](e)}removeUserById(e){const t=this.getUserById(e),s=new h({id:e});t.groups.forEach((t=>"lord"===t.role?s.removeGroupById(t.id):"admin"===t.role?s.leaveGroupById(t.id):void a.A.commit("sandBox/REMOVE_MEMBER",{gid:t.id,mid:e}))),t.friends.forEach((t=>{a.A.commit("sandBox/REMOVE_FRIEND",{fid:e,id:t.id})})),a.A.commit("sandBox/CLEAR_USER_MESSAGE",e),a.A.commit("sandBox/REMOVE_USER",e)}clearUSer(){a.A.commit("sandBox/CLEAR_USERS")}createGroup({id:e,name:t,members:s,lord:n,avatar:r}){if(!e&&!t)return!1;const i=`group-${e}`,a=this._memberNormalize(s),l=this.getGroupById(i);if(l)return!1;const d=new o({name:t,numId:e,lord:n,avatar:r}).mount();return a.forEach((async e=>{const t=e.id,s=this.getUserById(t);if(!s)return console.log(`用户${t}不存在`);const r=t===n?"lord":"member";d.addMember({uid:e.id,role:r})})),d.addMember({uid:n,role:"lord"}),d.addMember({uid:"user-super-admin",role:"super-admin"}),d}getAllGroup(){return a.A.getters["sandBox/getAllGroup"]}getGroupById(e){return a.A.getters["sandBox/getGroupById"](e)}removeGroupById(e){const t=a.A.getters["sandBox/getGroupById"](e).members;t.forEach((t=>{const s=a.A.getters["sandBox/getUserById"](t.id);s.groups=s.groups.filter((t=>t.id!==e))})),a.A.commit("sandBox/DEL_GROUP_MESSAGE",{gid:e}),a.A.commit("sandBox/REMOVE_GROUP",e)}_memberNormalize(e){let t;return e instanceof Array?e.map((e=>e instanceof Object?e:(t=a.A.getters["sandBox/getUserById"](e),t))).filter((e=>e)):e instanceof Object?[e]:(t=a.A.getters["sandBox/getUserById"](e),t&&"object"===typeof t?[t]:[])}__memberNormalize(e){return e instanceof Object?[e]:e instanceof Array?e.map((e=>e instanceof Object?e:a.A.getters["sandBox/getUserById"](`user-${e}`)||null)).filter((e=>null!==e)):(e=a.A.getters["sandBox/getUserById"](`user-${e}`),e&&e instanceof Object?[e]:[])}}var p=s(5675),f=function(){var e=this,t=e._self._c;return t("k-container",{staticClass:"left-aside",attrs:{direction:"horizontal"}},[t("k-sb-aside",{staticClass:"aside-users",scopedSlots:e._u([{key:"inner",fn:function(){return[e.getAllUser.length?t("k-menu",{attrs:{"default-active":e.getCurrentUser?.id,"active-color":"#752bec","active-shape":["circle"],"text-color":"#061e26","background-color":"#f2f2f2",mode:"column"}},e._l(e.getAllUser,(function(s,n){return t("k-menu-item",{key:n,attrs:{index:s.id,width:"60",height:"60"},on:{click:function(t){return e.switchUserFn(s.id)}}},[t("pps-context-menu",{attrs:{menus:s.isSuper?[]:[{label:"发起群聊",uid:`${s.id}`,task:1}]},on:{select:e.contextMenuFn},scopedSlots:e._u([{key:"item",fn:function({menu:s}){return e._l(s,(function(s,n){return t("div",{key:n,staticClass:"menu-item",on:{click:function(t){return e.contextMenuFn(s)}}},[e._v(" "+e._s(s.label)+" ")])}))}}],null,!0)},[t("template",{slot:"prepend"},[t("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"账户信息",placement:"top"}},[t("pps-icon",{attrs:{icon:"pps-icon-account"},on:{click:function(t){return e.showUserDetailFn(s)}}})],1),t("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"好友",placement:"top"}},[t("pps-icon",{attrs:{icon:"pps-icon-contact"},on:{click:function(t){return e.showFriendListFn(s)}}})],1),t("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"群聊",placement:"top"}},[t("pps-icon",{attrs:{icon:"pps-icon-group"},on:{click:function(t){return e.showGroupListFn(s)}}})],1)],1),s.isSuper?e._e():t("div",{staticClass:"delete-user",attrs:{slot:"append"},slot:"append"},[t("div",{on:{click:function(t){return e.contextMenuFn({uid:`${s.id}`,task:2})}}},[e._v(" "+e._s(`移除 ${s.name}`)+" ")])]),t("div",{staticClass:"user-avatar",attrs:{slot:"content"},slot:"content"},[t("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:s.name,placement:"right"}},[t("pps-avatar",{attrs:{src:s.avatar,size:"40"}})],1)],1)],2)],1)})),1):e._e()]},proxy:!0}])},[t("header",{staticClass:"k-chat-header"},[t("el-tooltip",{attrs:{effect:"dark",content:"添加用户",placement:"bottom"}},[t("div",{staticClass:"add-user-avatar",on:{click:function(t){e.show.createUser=!0}}},[t("img",{staticClass:"add-user",attrs:{src:e.ADD_USER_IMG,alt:"添加用户"}})])])],1),t("div",{staticClass:"fill-empty"}),e._e()],1),t("transition",[t("k-sb-aside",{directives:[{name:"show",rawName:"v-show",value:e.show.isCollapseMsg,expression:"show.isCollapseMsg"}],staticClass:"aside-list",scopedSlots:e._u([{key:"inner",fn:function(){return[t("k-menu",{key:e.messageList[0]?.id,ref:"msgMenuRef",staticClass:"list",attrs:{"default-active":null,"active-color":"#fff","active-shape":["background"],"text-color":"#061e26","background-color":"#a07fff",mode:"column"},on:{select:e.selectMsgFn}},e._l(e.showMessageList,(function(s){return t("k-menu-item",{key:s.id,attrs:{index:s.id,height:"60"}},[t("div",{staticClass:"list-item"},[t("pps-avatar",{attrs:{src:s.avatar,size:"40",title:s.name}}),t("div",{staticClass:"name",attrs:{title:s.name}},[t("span",{staticClass:"name-text"},[e._v(e._s(s.name))]),t("p",{staticClass:"name__message"},[e._v(e._s(s.message))])]),t("span",{staticClass:"closeBtn"},[e._v(" "+e._s(s.date)+" ")])],1)])})),1)]},proxy:!0}])},[t("header",{directives:[{name:"show",rawName:"v-show",value:e.show.isCollapseMsg,expression:"show.isCollapseMsg"}],staticClass:"k-chat-header"},[t("k-tab",{class:{isTransparent:!e.show.isCollapseMsg},attrs:{tabs:["私聊","群聊"]},on:{changeTab:e.toggleMsgTabFn}}),t("el-tooltip",{attrs:{effect:"dark",content:"加好友/群",placement:"bottom"}},[t("gray-button",{staticClass:"icon-btn",nativeOn:{click:function(t){e.show.addFriend=!0}}},[t("svg",{staticClass:"icon",attrs:{t:"1723230695956",viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"34315",width:"16",height:"16","data-spm-anchor-id":"a313x.search_index.0.i6.27883a81IeQ0Uy"}},[t("path",{attrs:{d:"M914.618182 477.090909H546.909091V109.381818c0-18.618182-16.290909-34.909091-34.909091-34.909091s-34.909091 16.290909-34.909091 34.909091v367.709091H109.381818c-18.618182 0-34.909091 16.290909-34.909091 34.909091s16.290909 34.909091 34.909091 34.909091h367.709091v367.709091c0 18.618182 16.290909 34.909091 34.909091 34.909091s34.909091-16.290909 34.909091-34.909091V546.909091h367.709091c18.618182 0 34.909091-16.290909 34.909091-34.909091s-16.290909-34.909091-34.909091-34.909091z",fill:"#7a7a7a","p-id":"34316"}})])])],1),t("el-tooltip",{attrs:{effect:"dark",content:"收起消息列表",placement:"right"}},[t("gray-button",{staticClass:"icon-btn",nativeOn:{click:function(t){return e.collapseMsghandler(!1)}}},[t("pps-icon",{attrs:{icon:"pps-icon-side-show"}})],1)],1)],1)])],1),e.getIsNarrowScreen?t("div",{directives:[{name:"show",rawName:"v-show",value:e.show.isCollapseMsg,expression:"show.isCollapseMsg"}],staticClass:"mask",on:{click:function(t){return e.collapseMsghandler(!1)}}}):e._e(),t("pps-dialog",{staticClass:"create-user-dialog",attrs:{show:e.show.createUser,title:"创建用户"},on:{"update:show":function(t){return e.$set(e.show,"createUser",t)},canceled:e.cancelCreateUserFn,confirmed:e.createUserFn},scopedSlots:e._u([{key:"content",fn:function(){return[t("pps-form",[t("pps-input",{attrs:{label:"昵称",content:e.createUser.name,placeholder:"请输入昵称"},on:{"update:content":function(t){return e.$set(e.createUser,"name",t)}}}),t("pps-input",{attrs:{label:"账号",content:e.createUser.id,placeholder:"请输入账号"},on:{"update:content":function(t){return e.$set(e.createUser,"id",t)}}}),t("pps-input",{attrs:{label:"年龄",content:e.createUser.age,type:"number",placeholder:"请输入年龄"},on:{"update:content":function(t){return e.$set(e.createUser,"age",t)}}}),t("div",{staticClass:"user-sex-wrapper"},[t("label",{staticClass:"sex-text-label",attrs:{for:"t"}},[e._v("性别:")]),t("el-radio",{attrs:{label:"男"},model:{value:e.createUser.sex,callback:function(t){e.$set(e.createUser,"sex",t)},expression:"createUser.sex"}},[e._v("男")]),t("el-radio",{attrs:{label:"女"},model:{value:e.createUser.sex,callback:function(t){e.$set(e.createUser,"sex",t)},expression:"createUser.sex"}},[e._v("女")])],1),t("pps-input",{attrs:{label:"头像",content:e.createUser.avatar,placeholder:"请输入https地址"},on:{"update:content":function(t){return e.$set(e.createUser,"avatar",t)}}})],1),t("hr"),t("div",{staticClass:"quick-wrapper"},[t("span",{staticClass:"quick__text"},[e._v("快速创建10个用户")]),t("pps-button",{staticClass:"quick__btn",attrs:{theme:"confirm"},on:{click:function(t){return e.bulkCreateUsers()}}},[t("i",{staticClass:"el-icon-plus"}),e._v(" 快速创建 ")])],1)]},proxy:!0}])}),t("pps-dialog",{attrs:{show:e.show.removeUser,title:"移除用户",content:`确定要移除${e.removeUser}用户吗？`},on:{"update:show":function(t){return e.$set(e.show,"removeUser",t)},confirmed:function(t){return e.removeUserFn(e.removeUser)}}}),t("pps-dialog",{staticClass:"add-friend-dialog",attrs:{"after-show":e.emitTabUpdate,show:e.show.addFriend,callback:e.closeAddObjDialogFn,title:"全站搜索"},on:{"update:show":function(t){return e.$set(e.show,"addFriend",t)}},scopedSlots:e._u([{key:"content",fn:function(){return[t("pps-input",{attrs:{clearable:"",content:e.searchDialog.input,placeholder:`请输入${e.searchDialog.tabs[e.searchDialog.index]} ID`},on:{change:function(t){return e.searchFn()},"update:content":function(t){return e.$set(e.searchDialog,"input",t)}}},[t("span",{staticStyle:{padding:"0 8px"},attrs:{slot:"prepend"},slot:"prepend"},[e._v(" "+e._s(e.searchDialog.tabPrefix[e.searchDialog.index])+"- ")])]),t("k-tab",{ref:"k-tab",attrs:{tabs:e.searchDialog.tabs},on:{changeTab:e.switchSearchTabFn},scopedSlots:e._u([{key:"thumb",fn:function(){return[t("div",{staticClass:"thumb"})]},proxy:!0}])}),t("el-table",{staticStyle:{width:"100%"},attrs:{data:e.tableData,border:""}},[t("el-table-column",{attrs:{align:"center",label:"搜索结果"},scopedSlots:e._u([{key:"default",fn:function(e){return[t("img",{staticClass:"avatar",attrs:{src:e.row.avatar,alt:""}})]}}])}),t("el-table-column",{attrs:{align:"center",prop:"name",label:"昵称"}}),t("el-table-column",{attrs:{align:"center",prop:"id",label:"id"}}),t("el-table-column",{attrs:{align:"center",label:"操作"},scopedSlots:e._u([{key:"default",fn:function({row:s}){return[t("pps-button",{attrs:{disabled:s.isAdded},on:{click:function(t){return e.addFriendFn(s.id)}}},[e._v(" "+e._s(s.isAdded?"已添加":"添加")+" ")])]}}])})],1)]},proxy:!0}])}),t("pps-dialog",{staticClass:"create-group-dialog",attrs:{show:e.show.createGroup,title:"发起群聊"},on:{"update:show":function(t){return e.$set(e.show,"createGroup",t)},confirmed:e.createGroupFn},scopedSlots:e._u([{key:"content",fn:function(){return[t("div",{staticClass:"create-group-content"},[t("div",{staticClass:"left",staticStyle:{"text-align":"center"}},[t("h4",[e._v("好友列表")]),t("el-table",{attrs:{"show-header":!0,data:e.getFriendListExceptSuper},on:{"selection-change":e.handleSelectionChange}},[t("el-table-column",{attrs:{type:"selection",align:"center",label:"选择"}}),t("el-table-column",{attrs:{align:"center",label:"头像"},scopedSlots:e._u([{key:"default",fn:function({row:e}){return[t("pps-avatar",{attrs:{src:e.avatar,size:"30",title:e.name}})]}}])}),t("el-table-column",{attrs:{prop:"name",align:"center",label:"名称"}})],1)],1),t("div",{staticClass:"right"},[t("pps-input",{attrs:{label:"群聊ID",content:e.createGroup.id,placeholder:"请输入ID"},on:{"update:content":function(t){return e.$set(e.createGroup,"id",t)}}}),t("pps-input",{attrs:{label:"群聊名称",content:e.createGroup.name,placeholder:"请输入名称"},on:{"update:content":function(t){return e.$set(e.createGroup,"name",t)}}}),t("pps-input",{attrs:{label:"群聊头像",content:e.createGroup.avatar,placeholder:"请输入链接"},on:{"update:content":function(t){return e.$set(e.createGroup,"avatar",t)}}})],1)])]},proxy:!0}])}),t("pps-dialog",{attrs:{show:e.show.friendList,title:"好友列表",callback:e.closeUserInfoFn},on:{"update:show":function(t){return e.$set(e.show,"friendList",t)}},scopedSlots:e._u([{key:"content",fn:function(){return[t("el-table",{attrs:{"show-header":!0,data:e.selectFreindLIst}},[t("el-table-column",{attrs:{align:"center",label:"头像"},scopedSlots:e._u([{key:"default",fn:function(e){return[t("pps-avatar",{attrs:{src:e.row.avatar,size:"40"}})]}}])}),t("el-table-column",{attrs:{align:"center",prop:"id",label:"id"}}),t("el-table-column",{attrs:{align:"center",prop:"name",label:"昵称"}}),t("el-table-column",{attrs:{align:"center",label:"操作"},scopedSlots:e._u([{key:"default",fn:function({row:s}){return[t("pps-button",{attrs:{disabled:"user-super-admin"===s.id,theme:"danger"},on:{click:function(t){return e.removeFriendFn(s.id)}}},[e._v(" 删除 ")])]}}])})],1)]},proxy:!0}])}),t("pps-dialog",{attrs:{show:e.show.groupList,title:"群聊列表",callback:e.closeUserInfoFn},on:{"update:show":function(t){return e.$set(e.show,"groupList",t)}},scopedSlots:e._u([{key:"content",fn:function(){return[t("el-table",{attrs:{data:e.selcetGroupList}},[t("el-table-column",{attrs:{align:"center",label:"群聊头像"},scopedSlots:e._u([{key:"default",fn:function(e){return[t("pps-avatar",{attrs:{src:e.row.avatar,size:"40"}})]}}])}),t("el-table-column",{attrs:{align:"center",prop:"id",label:"群聊id"}}),t("el-table-column",{attrs:{align:"center",prop:"name",label:"群聊名称"}}),t("el-table-column",{attrs:{align:"center",label:"操作"},scopedSlots:e._u([{key:"default",fn:function({row:s}){return[s.lord===e.userDetailDate.id?t("pps-button",{attrs:{disabled:s.lord!==e.userDetailDate.id,theme:"danger"},on:{click:function(t){return e.removeGroupFn(s)}}},[e._v(" 解散 ")]):t("pps-button",{attrs:{theme:"primary"},on:{click:function(t){return e.leaveGroupFn(s)}}},[e._v("退出")])]}}])})],1)]},proxy:!0}])}),t("pps-dialog",{attrs:{show:e.show.userInfo,title:"用户信息",callback:e.closeUserInfoFn},on:{"update:show":function(t){return e.$set(e.show,"userInfo",t)}},scopedSlots:e._u([{key:"content",fn:function(){return[t("div",{staticClass:"user-info-wrapper"},[t("img",{staticClass:"user-avatar",attrs:{src:e.userDetailDate.avatar,alt:""}}),t("el-descriptions",{staticClass:"margin-top",attrs:{column:2,border:""}},[t("el-descriptions-item",[t("template",{slot:"label"},[e._v("昵称")]),e._v(" "+e._s(e.userDetailDate.name)+" ")],2),t("el-descriptions-item",[t("template",{slot:"label"},[e._v("ID")]),e._v(" "+e._s(e.userDetailDate.id)+" ")],2),t("el-descriptions-item",[t("template",{slot:"label"},[e._v("年龄")]),e._v(" "+e._s(e.userDetailDate.age)+" ")],2),t("el-descriptions-item",[t("template",{slot:"label"},[e._v("性别")]),e._v(" "+e._s(e.userDetailDate.sex)+" ")],2)],1)],1)]},proxy:!0}])})],1)},v=[],b=(s(4114),s(2222)),M=s(4844),w=s(1349),C=function(){var e=this,t=e._self._c;return t("div",{staticClass:"k-tab-wrapper",on:{updateTab:e.changeTabFn}},[e._l(e.tabs,(function(s,n){return t("div",{key:n,ref:"tab-item",refInFor:!0,staticClass:"k-tab-item",on:{click:function(t){return e.changeTabFn(n)}}},[t("div",{staticClass:"k-tab-font",class:{"k-tab-current":e.current===n}},[e._v(e._s(s))])])})),t("div",{ref:"tab-thumb",staticClass:"tab-thumb",style:{left:e.x+"px",top:e.y+"px"}},[e._t("thumb",(function(){return[t("div",{staticClass:"k-tab-thumb"})]}))],2)],2)},_=[],x={name:"k-tab",props:{tabs:{type:Array,default(){return[]}},defaultActive:{type:Number,default(){return 0}}},data(){return{x:0,y:0,current:0}},methods:{changeTabFn(e=0){this.$emit("changeTab",e),this.current=e;const{offsetLeft:t,offsetTop:s}=this.$refs["tab-item"][e];this.x=t,this.y=s}},mounted(){this.changeTabFn(this.defaultActive)}},y=x,I=s(1656),A=(0,I.A)(y,C,_,!1,null,null,null),k=A.exports,U=s.p+"img/addAvatar.5d18468f.svg",E=s.p+"img/removeAvatar.102a1309.svg",B=function(){var e=this,t=e._self._c;return t("div",{staticClass:"gray-btn"},[e._t("default")],2)},S=[],F={name:"gray-button"},R=F,T=(0,I.A)(R,B,S,!1,null,null,null),G=T.exports;function D(e){const t=new Date(e),s=new Date,n=t.getFullYear(),r=t.getMonth(),i=t.getDate(),a=n===s.getFullYear()&&r===s.getMonth()&&i===s.getDate();return a?t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):`${$(r+1)}/${$(i)}`}function $(e){return e<10?"0"+e:e}var L={name:"sb-left-aside",components:{kSbAside:w.A,kContainer:p.A,kMenu:M.A,kMenuItem:b.A,kTab:k,grayButton:G},data(){return{users:[],admin:new g,ADD_USER_IMG:U,REMOVE_USER:E,messageMode:0,messageList:[],show:{createUser:!1,createGroup:!1,removeUser:!1,addFriend:!1,friendList:!1,groupList:!1,userInfo:!1,isCollapseMsg:!0},createUser:{name:null,avatar:null,id:null,age:null,sex:"男"},createGroup:{id:null,name:null,avatar:null,members:[],checkList:[]},removeUser:null,searchDialog:{tabs:["用户","群聊","机器人"],tabPrefix:["user","group","user"],index:0,input:""},tableData:[],userDetailDate:{}}},props:{updateChatTarget:{type:Function,default(){return null}},updateCollapseMsg:{type:Function,default(){return null}}},methods:{collapseMsghandler(e){this.show.isCollapseMsg=e,this.updateCollapseMsg(e)},switchUserFn(e){this.getCurrentUser.id!==e&&(this.$store.commit("sandBox/SWITCH_USER",e),this.$refs.msgMenuRef.activeIndex=null,this.$store.commit("sandBox/SWITCH_CHAT"),this.updateChatTarget(null,!1,null),this.collapseMsghandler(!0))},removeUserFn(e){this.admin.removeUserById(e),this.$store.commit("sandBox/SWITCH_USER")},createUserFn(){const e=this.createUser,t=e.id&&e.name&&e.age&&e.sex;if(!t)return void this.$dialog({title:"警告",content:"请填写完整信息"}).then((e=>{this.show.createUser=!0})).catch((e=>{console.log(e)}));const s=new h({numId:e.id,name:e.name,age:e.age,sex:e.sex,avatar:e.avatar}),n=s.mount();n||this.$dialog({title:"警告",content:"用户已存在"}).then((e=>{})).catch((e=>{console.log(e)})),this.cancelCreateUserFn()},createGroupFn(){const e=this.admin.createGroup({id:this.createGroup.id,name:this.createGroup.name,lord:this.userDetailDate.id,avatar:this.createGroup.avatar,members:this.createGroup.checkList});e||this.$dialog({title:"警告",content:"群聊创建失败！信息不完整或已存在"}).then((e=>{this.show.createGroup=!0})).catch((e=>{console.log(e)}))},handleSelectionChange(e){this.createGroup.checkList=e},cancelCreateUserFn(){this.createUser={name:null,avatar:null,id:null,age:null,sex:null}},contextMenuFn(e){this.removeUser=e.uid,2===e.task?this.show.removeUser=!0:1===e.task&&(this.userDetailDate=this.admin.getUserById(e.uid),this.show.createGroup=!0)},toggleMsgTabFn(e){this.messageMode=e},switchSearchTabFn(e){this.searchDialog.index=e,this.searchFn()},searchFn(){this.tableData=[];const e=this.searchDialog.input;if(!e)return;const t=new h(this.getCurrentUser),s=new g;switch(this.searchDialog.index){case 0:{const n=s.getAllUser();n.forEach((s=>{if(!s.isSuper&&s.numId.includes(e)){const e=t.friends.some((e=>e.id===s.id));this.tableData.push({...s,isAdded:e})}}));break}case 1:{const n=s.getAllGroup();n.forEach((s=>{if(s.id.includes(e)){const e=t.groups.some((e=>e.id===s.id));this.tableData.push({...s,isAdded:e})}}));break}case 2:{const n=s.getAllUser();n.forEach((s=>{if(s.isSuper&&s.numId.includes(e)){const e=t.friends.some((e=>e.id===s.id));this.tableData.push({...s,isAdded:e})}}));break}}},closeAddObjDialogFn(){this.tableData=[],this.searchDialog.input=""},addFriendFn(e){const t=new h(this.getCurrentUser);switch(this.searchDialog.index){case 0:{const t=this.admin.getUserById(e);this.$emit("handleMenuAction",{targetUser:t,actionType:"ADD_FRIEND"});break}case 1:t.addGroupById(e);break;case 2:break}},removeFriendFn(e){const t=this.admin.getUserById(e);this.$emit("handleMenuAction",{targetUser:t,actionType:"REMOVE_FRIEND",currentUser:this.userDetailDate})},emitTabUpdate(){this.$refs["k-tab"].changeTabFn()},deleteFriendMsgFn(e){const t=new h(this.getCurrentUser),s=t.deleteFriendMessage(e.id);console.log("删除消息",s)},removeGroupFn(e){const t=new h(this.userDetailDate);this.$emit("handleMenuAction",{targetUser:t,groupId:e.id,actionType:"REMOVE_GROUP"})},leaveGroupFn(e){const t=new h(this.userDetailDate);this.$emit("handleMenuAction",{targetUser:t,groupId:e.id,actionType:"LEAVE_GROUP"})},selectMsgFn({index:e}){const t=new h(this.getCurrentUser);let s;if(this.messageMode)s=t.getGroupMessageById(e),this.$store.commit("sandBox/SWITCH_CHAT",s),this.updateChatTarget(e,!0,s.name);else{s=t.getFriendMessageById(e),this.$store.commit("sandBox/SWITCH_CHAT",s);const n=this.admin.getUserById(e);this.updateChatTarget(e,!1,n.name)}this.$emit("switchMsg",s),this.collapseMsghandler(!this.getIsNarrowScreen)},selectNewMsgFn(e){return console.log(e),"test"},showUserDetailFn(e){Object.assign(this.userDetailDate,e),this.show.userInfo=!0},closeUserInfoFn(){this.userDetailDate={}},showFriendListFn(e){this.userDetailDate=e,this.show.friendList=!0},showGroupListFn(e){this.userDetailDate=e,this.show.groupList=!0},bulkCreateUsers(){const e=[{numId:"1",name:"u1",age:18,sex:"男"},{numId:"2",name:"u2",age:18,sex:"男"},{numId:"3",name:"u3",age:18,sex:"男"},{numId:"4",name:"u4",age:20,sex:"女"},{numId:"5",name:"u5",age:18,sex:"女"},{numId:"6",name:"u6",age:18,sex:"女"},{numId:"7",name:"u7",age:18,sex:"女"},{numId:"8",name:"u8",age:18,sex:"女"}];e.forEach((e=>{const t=new h(e).mount();console.log(t)}))}},computed:{...(0,i.L8)("sandBox",["getCurrentUser","getAllUser","getCurrentMsg"]),...(0,i.L8)("layoutOption",["getIsNarrowScreen"]),showMessageList(){const e=new h(this.getCurrentUser);let t=[];return t=this.messageMode?e.groups.map((({id:t})=>{let s,n;const r=e.getGroupById(t),i=e.getGroupMessageById(t).messages.at(-1);if(void 0===i)s=" ",n="";else{const e=this.admin.getUserById(i.role);s=`${e.name}: ${i.content}`,n=D(i.date)}return{...r,message:s,date:n}})):e.friends.map((t=>{let s,n;const r=e.getFriendMessageById(t.id).at(-1);return void 0===r?(s=" ",n=""):(s=r.content,n=D(r.date)),{...t,message:s,date:n}})),t},getFriendListExceptSuper(){const e=this.admin.getUserById(this.userDetailDate.id),t=e.friends.filter((e=>"user-super-admin"!==e.id));return t},selectFreindLIst(){const e=new h(this.userDetailDate),t=e.friends;return t},selcetGroupList(){const e=new h(this.userDetailDate),t=e.getAllGroups();return t}},watch:{getIsNarrowScreen(e){this.show.isCollapseMsg=!e}},created(){},mounted(){this.collapseMsghandler(!0)}},N=L,O=(0,I.A)(N,f,v,!1,null,"d637fd6a",null),P=O.exports,V=function(){var e=this,t=e._self._c;return t("transition",[t("div",{staticClass:"right-aside-wapper"},[t("k-sb-aside",{staticClass:"aside-group",scopedSlots:e._u([{key:"inner",fn:function(){return[t("ul",{staticClass:"member-list"},e._l(e.sortedMemberList,(function(s,n){return t("li",{key:n,staticClass:"member-item",on:{click:function(t){return e.viewUserProfile(s)}}},[t("pps-context-menu",{attrs:{menus:e.getUserMenuItems(s)},on:{select:e.avatarContextMenuFn}},[t("div",{staticClass:"user-item",attrs:{slot:"content"},slot:"content"},[t("pps-avatar",{attrs:{src:s.avatar,size:"20"}}),t("div",{staticClass:"user-name"},[e._v(e._s(s.name))]),e.chatTarget.isGroup?t("div",{staticClass:"user-role",class:s.role},[e._v(" "+e._s(e.tranRoleFn(s.role))+" ")]):e._e()],1)])],1)})),0)]},proxy:!0}])},[t("div",{staticClass:"member-title"},[t("div",{staticClass:"title"},[e._v("群聊成员-"+e._s(e.getGroupMemberLength)+"人")]),t("div",{staticClass:"btn-area"},[t("gray-button",{staticClass:"icon-btn",nativeOn:{click:function(t){e.isShowFriendList=!0}}},[t("el-tooltip",{attrs:{effect:"dark",content:"邀请加群",placement:"top"}},[t("svg",{staticClass:"icon",attrs:{t:"1723230695956",viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"34315",width:"16",height:"16","data-spm-anchor-id":"a313x.search_index.0.i6.27883a81IeQ0Uy"}},[t("path",{attrs:{d:"M914.618182 477.090909H546.909091V109.381818c0-18.618182-16.290909-34.909091-34.909091-34.909091s-34.909091 16.290909-34.909091 34.909091v367.709091H109.381818c-18.618182 0-34.909091 16.290909-34.909091 34.909091s16.290909 34.909091 34.909091 34.909091h367.709091v367.709091c0 18.618182 16.290909 34.909091 34.909091 34.909091s34.909091-16.290909 34.909091-34.909091V546.909091h367.709091c18.618182 0 34.909091-16.290909 34.909091-34.909091s-16.290909-34.909091-34.909091-34.909091z",fill:"#7a7a7a","p-id":"34316"}})])])],1),e.isShowMuteBtn?t("gray-button",{staticClass:"icon-btn",nativeOn:{click:function(t){return e.muteGroup.apply(null,arguments)}}},[t("el-tooltip",{attrs:{effect:"dark",content:e.isMuteAll?"解开禁言":"全体禁言",placement:"top"}},[t("i",{class:e.muteBtnClass})])],1):e._e(),t("gray-button",{staticClass:"icon-btn leave",nativeOn:{click:function(t){return e.leaveGroupFn()}}},[t("el-tooltip",{attrs:{effect:"dark",content:"退出群聊",placement:"top"}},[t("i",{staticClass:"layui-icon layui-icon-close"})])],1)],1)])]),t("pps-dialog",{attrs:{show:e.isShowFriendList,title:"好友列表"},on:{"update:show":function(t){e.isShowFriendList=t}},scopedSlots:e._u([{key:"content",fn:function(){return[t("el-table",{attrs:{"show-header":!0,data:e.getCurrentUser.friends}},[t("el-table-column",{attrs:{align:"center",label:"头像"},scopedSlots:e._u([{key:"default",fn:function(e){return[t("pps-avatar",{attrs:{src:e.row.avatar,size:"40"}})]}}])}),t("el-table-column",{attrs:{align:"center",prop:"id",label:"id"}}),t("el-table-column",{attrs:{align:"center",prop:"name",label:"昵称"}}),t("el-table-column",{attrs:{align:"center",label:"操作"},scopedSlots:e._u([{key:"default",fn:function({row:s}){return[t("pps-button",{attrs:{disabled:e.isInvited(s),theme:e.isInvited(s)?"primary":"confirm"},on:{click:function(t){return e.inviteFriendFn(s)}}},[e._v(" "+e._s(e.isInvited(s)?"已进群":"邀请")+" ")])]}}])})],1)]},proxy:!0}])})],1)])},z=[],H=s(9529);const W={member:1,admin:2,lord:3,"super-admin":4},j={VIEW_PROFILE:{label:"查看资料",roles:["member","admin","lord","super-admin"]},AT_USER:{label:"@ TA",roles:["member","admin","lord","super-admin"],excludeSelf:!0},ADD_FRIEND:{label:"添加好友",roles:["member","admin","lord","super-admin"],excludeSelf:!0,friendRelation:"not-friend"},REMOVE_FRIEND:{label:"移除好友",roles:["member","admin","lord","super-admin"],excludeSelf:!0,friendRelation:"friend"},MUTE_USER:{label:"设置禁言",roles:["admin","lord","super-admin"],minTargetLevel:1,maxTargetLevel:1,requireNotMuted:!0},UNMUTE_USER:{label:"取消禁言",roles:["admin","lord","super-admin"],minTargetLevel:1,maxTargetLevel:1,requireMuted:!0},REMOVE_USER:{label:"移出本群",roles:["admin","lord","super-admin"],minTargetLevel:1,maxTargetLevel:1},SET_ADMIN:{label:"设为管理",roles:["lord","super-admin"],minTargetLevel:1,maxTargetLevel:1,requireNotAdmin:!0},REVOKE_ADMIN:{label:"撤销管理",roles:["lord","super-admin"],minTargetLevel:2,maxTargetLevel:2,requireAdmin:!0}},q=(e={role:null,id:null},t,s)=>{if(!t)return[];W[e.role];const n=W[t.role]||0,r=Q(e,t),i=Y(t,s),a=X(t,s);return Object.entries(j).filter((([s,o])=>{const{roles:l,excludeSelf:d,friendRelation:c,minTargetLevel:u,maxTargetLevel:h,requireMuted:m,requireNotMuted:g,requireAdmin:p,requireNotAdmin:f}=o;return l.includes(e.role)?d&&e.id===t.id?K("您不能操作自己"):u&&n<u?K("目标用户等级不足"):h&&n>h?K("目标用户等级过高"):"friend"!==c||r?"not-friend"===c&&r?K("您已经是好友关系"):m&&!i?K("用户未被禁言"):g&&i?K("用户被已禁言"):p&&!a?K("用户不是群组管理员"):!f||!a||K("用户是群组管理员"):K("您不是好友关系"):K("您没有权限执行此操作")})).map((([e,s])=>({key:e,label:s.label,uid:t.id,task:e.toLowerCase().replace(/_/g,"-")})))},K=e=>!1,Y=(e,t)=>t.getAllMessage().muteMembers.includes(e.id)||!1,Q=(e,t)=>e.friends.some((({id:e})=>e===t.id)),X=(e,t)=>{const s=t.getMemberById(e.id),n=s.role,r=e.groups.find((({id:e})=>e===t.id)).role;return"admin"===n||"admin"===r};var J={name:"sb-right-aside",components:{kSbAside:w.A,grayButton:G},mixins:[H.B],data(){return{admin:new g,group:null,isShowFriendList:!1}},methods:{getUserMenuItems(e){const t=this.memberList.find((({id:e})=>e===this.getCurrentUser.id)),s=new o({id:this.chatTarget.id}),n=q(t,e,s);return n},viewUserProfile(e){this.$emit("handleMenuAction",{targetUser:e,actionType:"VIEW_PROFILE"})},inviteFriendFn(e){this.$emit("handleMenuAction",{targetUser:e,actionType:"INVITE_FRIEND",groupId:this.chatTarget.id})},isInvited(e){const t=new o({id:this.chatTarget.id}).getMemberById(e.id);return!!t},leaveGroupFn(){this.$dialog({title:"警告",content:"确定要退出群聊吗？"}).then((e=>{const t=this.getCurrentUser;console.log(this.group,t),this.group.lord===t.id?this.$emit("handleMenuAction",{actionType:"REMOVE_GROUP",groupId:this.chatTarget.id,targetUser:t}):this.$emit("handleMenuAction",{actionType:"LEAVE_GROUP",groupId:this.chatTarget.id,targetUser:t})})).catch((e=>{console.log(e)}))},muteGroup(){const e=new h(this.getCurrentUser).getGroupMessageById(this.chatTarget.id).isMute;this.$emit("handleMenuAction",{actionType:"MUTE_GROUP",groupId:this.chatTarget.id,currentUser:!e})}},computed:{...(0,i.L8)("sandBox",["getCurrentUser","getGroupMessage"]),...(0,i.L8)("layoutOption",["getIsNarrowScreen"]),sortedMemberList(){const e=new Map([["super-admin",0],["lord",1],["admin",2],["member",3]]),t=t=>e.has(t)?e.get(t):4,s=[...this.memberList].sort(((e,s)=>t(e.role)-t(s.role)));return s},getGroupMemberLength(){return this.memberList.length},isMuteAll(){return this.getGroupMessage(this.group.id).isMute},muteBtnClass(){return this.isMuteAll?"el-icon-turn-off-microphone":"el-icon-microphone"},isShowMuteBtn(){const e=new h(this.getCurrentUser);return e._isAdmin(this.chatTarget.id)}},watch:{},created(){this.group=new o({id:this.chatTarget.id})},mounted(){}},Z=J,ee=(0,I.A)(Z,V,z,!1,null,"c379eb52",null),te=ee.exports,se=function(){var e=this,t=e._self._c;return t("div",{staticClass:"k-chat-main chat-empty"},[e.getCurrentMsg?[t("div",{ref:"chatBox",staticClass:"k-chat-box pps-scrollbar"},[e.isTalkWithBot?t("el-alert",{attrs:{title:"温馨提示！",center:"","show-icon":"","close-text":"知道了"}},[e._v(" 输入 "),t("strong",{staticClass:"danger-text"},[e._v("/help")]),e._v(" 查看所有bot指令 ")]):e._e(),e._l(e.messageList,(function(s){return t("k-sb-message",{key:s.id,attrs:{message:s,chatTarget:e.chatTarget,isSelf:e.isSelfFn(s.role),memberList:e.memberList},on:{replyMsg:e.replyMsgFn,handleMenuAction:e.handleMenuAction}})}))],2),t("div",{staticClass:"k-chat-input-box"},[t("div",{ref:"input",staticClass:"k-chat-input",attrs:{contenteditable:e.messagingEnabled,placeholder:e.messagingPlaceholder},on:{input:e.inputFn,click:e.saveRange,keyup:e.saveRange,keypress:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.sendMessageFn.apply(null,arguments)},blur:function(t){e.lastRange=null},paste:e.handlePaste}}),t("div",{staticClass:"operation"},[t("div",{directives:[{name:"show",rawName:"v-show",value:e.replyMsg.name,expression:"replyMsg.name"}],staticClass:"reply-chat-wrapper"},[t("span",{staticClass:"content"},[e._v(e._s(e.replyMsg.name)+"："+e._s(e.replyMsg.content))]),t("i",{staticClass:"el-icon-circle-close",on:{click:e.cancelReplyMsgFn}})]),t("pps-button",{staticClass:"k-chat-send-btn",attrs:{disabled:!e.messagingEnabled,theme:"confirm"},on:{click:e.sendMessageFn}},[e._v(" 发送 ")])],1)])]:t("el-empty",{staticStyle:{height:"100%"},attrs:{description:"",image:e.LOGO}})],2)},ne=[],re=s.p+"img/favicon-gray.c2bacd13.svg",ie=function(){var e=this,t=e._self._c;return t("div",{staticClass:"k-sb-message",class:{"k-sb-message-self":e.isSelf}},[t("div",{staticClass:"message"},[t("pps-context-menu",{attrs:{menus:e.getUserMenuItems()},on:{select:e.avatarContextMenuFn}},[t("div",{staticStyle:{width:"36px"},attrs:{slot:"content"},slot:"content"},[t("pps-avatar",{staticStyle:{"user-select":"none"},attrs:{size:"36",src:e.getUserAvatarFn(e.message.role)},on:{click:function(t){return e.viewUserProfile()}}})],1)]),t("div",{staticClass:"container"},[t("div",{staticClass:"nickname_wrapper"},[e.chatTarget.isGroup?t("span",{staticClass:"groupRole",class:e.getGroupSenderRole.role},[e._v(" "+e._s(e.getRole)+" ")]):e._e(),t("span",{staticClass:"nickname"},[e._v(e._s(e.getUserNickname))]),t("span",{directives:[{name:"trans-time",rawName:"v-trans-time",value:e.message.date,expression:"message.date"}],staticClass:"date"})]),t("pps-context-menu",{attrs:{menus:e.getTextMenus},on:{select:e.testContextMenuFn}},[t("div",{staticClass:"content",attrs:{slot:"content"},slot:"content"},[t("pre",[e._v(e._s(e.message.content||" "))])])]),e.message.replyMsg?.name?t("div",{staticClass:"reply"},[e._v(" "+e._s(e.message.replyMsg.name)+"："+e._s(e.message.replyMsg.content)+" ")]):e._e()],1)],1)])},ae=[],oe={name:"k-sb-message",data(){return{admin:new g}},mixins:[H.B],props:{message:{type:Object,default(){return{}}},isSelf:{type:Boolean,default:!1},avatar:{type:String,default:""}},methods:{...(0,i.i0)("sandBox",["send"]),getUserAvatarFn(e){return"self"===e?this.getCurrentUser.avatar:"friend"===e?this.admin.getUserById(this.message.sender).avatar:this.admin.getUserById(this.message.role).avatar},deleteMsgFn(e){if(this.message.isGroup){const t=e.deleteGroupMessage({id:this.chatTarget.id,msgId:this.message.id});t?(this.$message.success("删除成功"),this.send({event:"on_message_delete",time:Date.now(),type:1,userId:e.id,messageId:this.message.id,operatorId:e.id,groupId:this.chatTarget.id})):this.$message.error("删除失败！")}else{console.log(this.message.receiver,this.message.id);const t=e.deleteFriendMessage(this.message.receiver,this.message.id);t?(this.$message.success("删除成功"),this.send({event:"on_message_delete",time:Date.now(),type:0,userId:e.id,messageId:this.message.id})):this.$message.error("删除失败！")}},testContextMenuFn({task:e}){const t=new h(this.getCurrentUser);0===e?this.deleteMsgFn(t):1===e&&this.$emit("replyMsg",this.message)},getUserMenuItems(){if(this.chatTarget.isGroup){const e=this.memberList.find((({id:e})=>e===this.getCurrentUser.id)),t=this.memberList.find((({id:e})=>e===this.message.role)),s=new o({id:this.chatTarget.id});return q(e,t,s)}return[]},viewUserProfile(){const e=this.admin.getUserById(this.message.role);this.$emit("handleMenuAction",{targetUser:e,actionType:"VIEW_PROFILE"})}},computed:{...(0,i.L8)("sandBox",["getCurrentUser","getCurrentMsg"]),getUserNickname(){let e;return e="self"===this.message.role?this.getCurrentUser.name:"friend"===this.message.role?this.admin.getUserById(this.message.sender).name:this.admin.getUserById(this.message.role).name,e||"u3"},getTextMenus(){return this.isSelf?[{label:"回复消息",task:1},{label:"删除消息",task:0}]:[{label:"回复消息",task:1}]},getGroupSenderRole(){const e={role:"expellee",id:"未知"};if(this.chatTarget.isGroup){const t=this.memberList.find((({id:e})=>e===this.message.role));return t||e}return e},getRole(){return this.tranRoleFn(this.getGroupSenderRole.role)}},mounted(){}},le=oe,de=(0,I.A)(le,ie,ae,!1,null,"5cbc5b36",null),ce=de.exports,ue={name:"k-chat-main",components:{kSbMessage:ce},data(){return{muteStatusIntervalId:null,LOGO:re,message:"",lastRange:null,replyMsg:{name:null,content:null},admin:new g,isComposing:!1,cursorPosition:null,inputObserver:null}},computed:{...(0,i.L8)("sandBox",["getCurrentUser","getAllUser","getCurrentMsg","getMemberMuteStatue"]),messagingEnabled(){if(this.chatTarget.isGroup){const e=new h(this.getCurrentUser),t=e._isAdmin(this.chatTarget.id);if(t)return!0;const s=this.getCurrentMsg.isMute,n=this.getMemberMuteStatue(this.chatTarget.id,e.id);return n&&this.checkMuteStatus(),!(s||n)}return!0},messagingPlaceholder(){return this.messagingEnabled?"请输入消息...":"禁言中..."},messageList(){const e=this.getCurrentMsg;if(!e)return[];let t;return t=Array.isArray(e)?e:e.messages,t},isTalkWithBot(){return!0}},methods:{...(0,i.i0)("sandBox",["send","updateMemberMuteStatue"]),...(0,i.PY)("sandBox",{clearMuteExpire:"UNMUTE_MEMBER"}),checkMuteStatus(){const e=this.getCurrentMsg.id,t=this.getCurrentUser.id;this.muteStatusIntervalId=setInterval((()=>{const s=this.getMemberMuteStatue(e,t);s||(this.clearMuteExpire({gid:e,mid:t}),clearInterval(this.muteStatusIntervalId))}),2e3)},inputFn(e){this.isComposing||(this.saveRange(),this.updateMessage())},updateMessage(){this.$nextTick((()=>{const e=this.$refs.input;e&&(this.message=this.getTextContent(e))}))},getTextContent(e){let t="";const s=e.childNodes;for(let n=0;n<s.length;n++){const e=s[n];e.nodeType===Node.TEXT_NODE?t+=e.textContent:e.nodeType===Node.ELEMENT_NODE&&("BUTTON"===e.tagName&&e.className.includes("pps-button")?t+=e.textContent:"BR"===e.tagName?t+="\n":t+=e.textContent)}return t},setInputContent(e,t=!0){const s=this.$refs.input;if(!s)return;let n=null;t&&(n=this.saveCurrentRange()),s.innerHTML=e,t&&n&&this.$nextTick((()=>{this.restoreRange(n)}))},saveCurrentRange(){const e=window.getSelection();if(e.rangeCount>0){const t=e.getRangeAt(0),s=this.$refs.input;if(s&&s.contains(t.commonAncestorContainer))return{startContainer:t.startContainer,startOffset:t.startOffset,endContainer:t.endContainer,endOffset:t.endOffset}}return null},restoreRange(e){if(e)try{const t=window.getSelection(),s=document.createRange();s.setStart(e.startContainer,e.startOffset),s.setEnd(e.endContainer,e.endOffset),t.removeAllRanges(),t.addRange(s),this.lastRange=s}catch(t){console.warn("Failed to restore cursor position:",t),this.focusAtEnd()}},focusAtEnd(){const e=this.$refs.input;if(!e)return;e.focus();const t=document.createRange(),s=window.getSelection();t.selectNodeContents(e),t.collapse(!1),s.removeAllRanges(),s.addRange(t),this.lastRange=t},saveRange(){const e=window.getSelection();if(e.rangeCount>0){const t=e.getRangeAt(0),s=this.$refs.input;s&&s.contains(t.commonAncestorContainer)&&(this.lastRange=t.cloneRange())}},handlePaste(e){e.preventDefault();const t=(e.clipboardData||window.clipboardData).getData("text/plain"),s=t.replace(/\r?\n/g," ");this.insertTextAtCursor(s)},insertTextAtCursor(e){const t=window.getSelection(),s=this.$refs.input;if(!s)return;s.focus();let n=null;this.lastRange&&this.isRangeInNode(this.lastRange,s)?n=this.lastRange:(n=document.createRange(),n.selectNodeContents(s),n.collapse(!1)),t.removeAllRanges(),t.addRange(n);const r=document.createTextNode(e);n.deleteContents(),n.insertNode(r);const i=document.createRange();i.setStartAfter(r),i.collapse(!0),t.removeAllRanges(),t.addRange(i),this.lastRange=i,this.updateMessage()},mentionMember(e){const t=this.$refs.input;if(!t)return;t.focus();const s=window.getSelection();s.removeAllRanges();let n=null;this.lastRange&&this.isRangeInNode(this.lastRange,t)?n=this.lastRange:(n=document.createRange(),n.selectNodeContents(t),n.collapse(!1)),s.addRange(n);const r=document.createElement("button");r.textContent=`@${e}`,r.contentEditable="false",r.className="pps-button-text pps-button",r.style.cssText="margin: 0 2px; pointer-events: none;",n.deleteContents(),n.insertNode(r);const i=document.createTextNode(" ");r.parentNode.insertBefore(i,r.nextSibling);const a=document.createRange();a.setStartAfter(i),a.collapse(!0),s.removeAllRanges(),s.addRange(a),this.lastRange=a,this.updateMessage()},clearInput(){const e=this.$refs.input;e&&(e.innerHTML="",this.message="",this.lastRange=null,e.focus())},handleCompositionStart(){this.isComposing=!0},handleCompositionEnd(){this.isComposing=!1,this.updateMessage()},sendMessageFn(e){if("Enter"===e.key&&(e.preventDefault(),this.isComposing))return;if(!this.message.trim())return;const t=new h(this.getCurrentUser);if(this.chatTarget.isGroup){const e=t.sendMessageToGroup({id:this.chatTarget.id,content:this.message,replyMsg:this.replyMsg}),s=e.data.message,n={lord:"owner",member:"member",admin:"admin","super-admin":"owner"},r=t.groups.find((t=>t.id===e.data.gid)).role;this.send({event:"on_message",time:s.date,type:1,messageId:s.id,message:s.content,messageAlt:s.content,userId:s.role,groupId:e.data.gid,sender:{nickname:t.name,role:n[r]}})}else{const e=t.sendMessageToFriend({id:this.chatTarget.id,content:this.message,replyMsg:this.replyMsg});"user-super-admin"===this.chatTarget.id&&this.sendMsgToBot(e,t)}this.clearInput(),this.cancelReplyMsgFn(),this.scrollToBottom(!0)},sendMsgToBot(e,t){const s=e.data.message;this.send({event:"on_message",time:s.date,type:0,messageId:s.id,message:s.content,messageAlt:s.content,userId:e.data.sender,sender:{nickname:t.name}})},async setGroupAdminFn(){const{value:e}=await this.$prompt("请输入群成员id","设置群管理员",{confirmButtonText:"确定",cancelButtonText:"取消"}),t=new h(this.getCurrentUser).setGroupAdmin({gid:this.chatTarget.id,mid:e});console.log(t)},isSelfFn(e){return"self"===e||"friend"!==e&&e===this.getCurrentUser.id},isRangeInNode(e,t){if(!e||!t)return!1;const s=e.commonAncestorContainer;return t.contains(s)},replyMsgFn(e){let t;t=this.chatTarget.isGroup?this.admin.getUserById(e.role).name:this.admin.getUserById(e.sender).name,this.replyMsg={name:t,content:e.content},this.$refs.input.focus()},handleMenuAction(e){this.$emit("handleMenuAction",e)},cancelReplyMsgFn(){this.replyMsg={name:null,content:null}},scrollToBottom(e=!1){const t=this.$refs.chatBox;t&&this.$nextTick((()=>{e?t.scrollTo({top:t.scrollHeight,behavior:"smooth"}):t.scrollTop=t.scrollHeight}))},updatePlaceholder(){const e=this.$refs.input;e&&(""===e.textContent.trim()?e.setAttribute("data-placeholder",this.messagingPlaceholder):e.removeAttribute("data-placeholder"))}},watch:{getCurrentMsg(e){this.cancelReplyMsgFn(),this.$refs.input&&this.clearInput()},messagingEnabled(e){e||this.clearInput()}},props:{chatTarget:{type:Object,default(){return null}},memberList:{type:Array,default(){return[]}}},created(){},mounted(){const e=this.$refs.input;e&&(e.focus(),e.addEventListener("compositionstart",this.handleCompositionStart),e.addEventListener("compositionend",this.handleCompositionEnd),this.updatePlaceholder()),this.$nextTick((()=>{this.scrollToBottom()}))},beforeDestroy(){const e=this.$refs.input;e&&(e.removeEventListener("compositionstart",this.handleCompositionStart),e.removeEventListener("compositionend",this.handleCompositionEnd)),this.muteStatusIntervalId&&clearInterval(this.muteStatusIntervalId)},updated(){this.scrollToBottom(),this.updatePlaceholder()}},he=ue,me=(0,I.A)(he,se,ne,!1,null,"8226c1b8",null),ge=me.exports,pe=s(9109),fe={name:"sandBox",components:{kContainer:p.A,sbLeftAside:P,sbRightAside:te,sbChatMain:ge,grayButton:G},data(){return{show:{isShowUsers:!0,isShowGroups:!0,isShowChatBox:!0,isCollapseMsg:!0,isCollapseRight:!0},screen:{width:0,height:0},admin:new g,chatTarget:{id:"",isGroup:!1,name:""}}},methods:{...(0,i.i0)("sandBox",["initWebSocket","send","close"]),test(){const e=new g,t=e.createUser({id:1,name:"jack",age:18,sex:"男"}),s=e.createUser({id:2,name:"tom",age:28,sex:"男"}),n=e.createUser({id:3,name:"lucy",age:17,sex:"女"}),r=new h({id:4,name:"mary",age:19,sex:"女"}),i=new h({id:"21022102cz",name:"只陌予",age:22,sex:"女"});e.createGroup({id:11,name:"group1",members:["user-1","user-2","user-3","user-4"],lord:"user-1"}),e.createGroup({id:22,name:"group2",members:["user-3",t,s],lord:"user-2"}),e.createGroup({id:33,name:"group3",members:["user-1","user-2",n,i],lord:"user-3"}),r.addFriend("user-2")&&console.log("mary添加tom成功"),t.addFriend("user-3")&&console.log("jack添加tom成功"),r.addFriend("user-1"),s.addFriend("user-1"),t.sendMessageToFriend({id:"user-2",content:"你好"}),t.sendMessageToFriend({id:"user-3",content:"你好"}),t.sendMessageToFriend({id:"user-4",content:"你好"}),n.inviteUserToGroup({groupId:"group-33",invitee:"user-4",role:"admin"})},createUser({id:e,name:t,age:s,sex:n}){new h({id:e,name:t,age:s,sex:n})},collapseMsghandler(){this.$refs.leftAsideRef.collapseMsghandler(!0),this.show.isCollapseRight=!1},collapseRighthandler(){this.show.isCollapseRight=!this.show.isCollapseRight},updateChatTargetFn(e,t,s){this.chatTarget.id=e,this.chatTarget.isGroup=t,this.chatTarget.name=s},updateCollapseMsgFn(e){this.show.isCollapseMsg=e},switchMsgCallback(e){},handleMenuAction(e){const{actionType:t,currentUser:s,targetUser:n,groupId:r}=e,i={VIEW_PROFILE:this.viewUserProfile,ADD_FRIEND:this.addFriend,REMOVE_FRIEND:this.removeFriend,AT_USER:this.mentionUser,REMOVE_USER:this.kickMember,MUTE_USER:this.muteMember,UNMUTE_USER:this.unmuteMember,REVOKE_ADMIN:this.revokeAdmin,SET_ADMIN:this.setAdmin,MUTE_GROUP:this.handleMuteGroup,REMOVE_GROUP:this.removeGroup,LEAVE_GROUP:this.leaveGroup,INVITE_FRIEND:this.inviteFriend};i[t]&&i[t](n,r,s)},viewUserProfile(e,t,s){this.$refs.leftAsideRef.showUserDetailFn(e)},mentionUser(e,t,s){this.messagingEnabled?this.$refs.chatMainRef.mentionMember(e.name):this.$message.info("禁言中，请解禁后再试！")},addFriend(e,t,s){const n=new h(this.getCurrentUser),r=n.addFriend(e.id);r?(this.$message.success("添加成功！"),this.send({event:"on_friend_increase",time:Date.now(),type:0,userId:n.id})):this.$message.error("添加失败！")},removeFriend(e,t,s){const n=new h(this.getCurrentUser),r=n.removeFriendById(e.id);r&&this.send({event:"on_friend_decrease",time:Date.now(),type:0,userId:n.id})},removeGroup(e,t,s){const n=new h(e),r=n.removeGroupById(t);r||this.$dialog({title:"警告",content:"群聊删除失败！"})},leaveGroup(e,t,s){const n=new h(e),r=n.leaveGroupById(t);r?(this.$message.success("已退出群聊！"),this.send({event:"on_group_decrease",time:Date.now(),type:1,userId:e.id,operatorId:e.id,groupId:t})):this.$message.error("群聊退出失败！")},inviteFriend(e,t,s){const n=new h(this.getCurrentUser),r=n.inviteUserToGroup({groupId:t,invitee:e.id});r?this.send({event:"on_group_increase",time:Date.now(),type:1,userId:e.id,operatorId:n.id,groupId:t}):this.$message.error("邀请失败！")},muteMember(e,t,s){if(0===s)return this.unmuteMember(e,t);const n=new h(this.getCurrentUser),r=n.muteMemberById(t,e.id,s);r?this.send({event:"on_group_ban",userId:e.id,operatorId:n.id,groupId:t,duration:s}):this.botSendGroupMsg({groupId:t,message:"管理员无法禁言！"})},unmuteMember(e,t,s){const n=new h(this.getCurrentUser),r=n.unmuteMemberById(t,e.id);r&&this.send({event:"on_group_ban",userId:e.id,operatorId:n.id,groupId:t,duration:0})},handleMuteGroup(e,t,s){console.log(e,t,s);const n=e??s,r=new h(this.getCurrentUser),i=r.handleMuteGroupById(t,n);i&&this.send({event:"on_group_whole_ban",type:1,operatorId:r.id,operation:s?"set":"unset",groupId:t,time:Date.now()})},kickMember(e,t,s){const n=new h(this.getCurrentUser),r=n.kickMemberById({groupId:t,expellee:e.id});r?(this.$message.success("已移出群聊！"),this.send({event:"on_group_decrease",time:Date.now(),type:1,userId:e.id,operatorId:n.id,groupId:t})):this.$message.error("移除失败！")},setAdmin(e,t,s){const n=new h(this.getCurrentUser).setGroupAdmin({gid:t,mid:e.id});n&&this.send({event:"on_group_admin",time:Date.now(),type:1,userId:e.id,operation:"set",groupId:t})},revokeAdmin(e,t,s){const n=new h(this.getCurrentUser).revokeGroupAdmin(t,e.id);n&&this.send({event:"on_group_admin",time:Date.now(),type:1,userId:e.id,operation:"unset",groupId:t})},receiveWsMsg(e){const t={send_private_msg:this.botSendPrivateMsg,send_group_msg:this.botSendGroupMsg,on_data_error:this.t};if(t[e.action])t[e.action](e);else if("set_group_whole_ban"===e.action)this.handleMuteGroup(e.enable,e.groupId);else if("set_group_ban"===e.action){console.log(e.userId);const t=new h({id:e.userId});this.muteMember(t,e.groupId,e.time)}},t(e){},botSendPrivateMsg(e){const t=new h({numId:"super-admin"});t.sendMessageToFriend({id:e.userId,content:e.message,replyMsg:null})},botSendGroupMsg(e){const t=new h({numId:"super-admin"});t.sendMessageToGroup({id:e.groupId,content:e.message,replyMsg:null})},initSandboxWsAliveFn(){this.isKeepSandboxWsAlive||this.close()}},computed:{...(0,i.L8)("sandBox",["getCurrentUser","getCurrentMsg"]),...(0,i.L8)("layoutOption",["getIsNarrowScreen"]),...(0,i.aH)("sandBox",["isKeepSandboxWsAlive"]),getMemberList(){if(this.chatTarget.isGroup&&this.getCurrentMsg){const e=this.admin.getGroupById(this.chatTarget.id);return e?new o({id:e.id}).getAllMember():[]}return[]},getGroupMemberLength(){return this.chatTarget.isGroup?`（${this.getMemberList.length}）`:null},messagingEnabled(){if(this.chatTarget.isGroup){const e=new h(this.getCurrentUser),t=e._isAdmin(this.chatTarget.id);if(t)return!0;const s=this.getCurrentMsg.isMute,n=this.getCurrentMsg.muteMembers.includes(e.id);return!(s||n)}return!0},isShowRightMask(){return this.getIsNarrowScreen&&this.show.isCollapseRight},isShowRightAside(){return this.show.isCollapseRight}},watch:{getIsNarrowScreen:{handler(e){this.show.isCollapseRight=!e},immediate:!0},getCurrentMsg:{handler(e){null===e&&(this.chatTarget={id:"",isGroup:!1})},deep:!0}},created(){this.$store.commit("sandBox/SWITCH_USER"),this.$store.commit("sandBox/SWITCH_CHAT"),this.initWebSocket(),pe.A.$on("onmessage",this.receiveWsMsg)},mounted(){},beforeDestroy(){pe.A.$off("onmessage",this.receiveWsMsg),this.initSandboxWsAliveFn()}},ve=fe,be=(0,I.A)(ve,n,r,!1,null,"050404f6",null),Me=be.exports},9529:function(e,t,s){s.d(t,{B:function(){return r},U:function(){return n}});const n={methods:{toggleFullscreen(){this.isFullscreen()?this.exit():this.enter(document.documentElement)},isFullscreen(){return!!document.fullscreenElement||!!document.webkitFullscreenElement||!!document.mozFullScreenElement||!!document.msFullscreenElement||null},enter(e){e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.msRequestFullscreen&&e.msRequestFullscreen()},exit(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen()}}},r={props:{chatTarget:{type:Object,default(){return null}},memberList:{type:Array,default(){return[]}}},methods:{tranRoleFn(e){const t={lord:"群主",admin:"管理员","super-admin":"bot",expellee:"已退群"};return t[e]||""},avatarContextMenuFn(e){const{uid:t,task:s,key:n}=e;if(s){const e=this.admin.getUserById(t);this.$emit("handleMenuAction",{targetUser:e,actionType:n,groupId:this.chatTarget.id})}}}}}}]);
//# sourceMappingURL=5.f818b113.js.map